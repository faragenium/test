name: Deployment Time Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  schedule:
    # Run at 4 PM weekdays to automatically block merges
    - cron: '0/5 * * * *'  # 21:00 UTC = 4 PM EST

jobs:
  time-gate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      if: github.event_name == 'push'
      with:
        fetch-depth: 2

    - name: Check deployment window
      env:
        TIMEZONE: Africa/Cairo

      run: |
          HOUR=$(date -u +"%H")      # 00 to 23
          MINUTE=$(date -u +"%M")    # 00 to 59
          echo "Current UTC Time: $HOUR:$MINUTE"

          IN_WINDOW=false

          if [ "$HOUR" -ge 9 ] && [ "$HOUR" -lt 9 ] && [ "$MINUTE" -ge 0 ] && [ "$MINUTE" -lt 7 ]; then
            IN_WINDOW=true
          fi

        
        if [ "${{ github.event_name }}" = "push" ]; then
          # Validate completed merge
          if git log --merges --oneline -1 | grep -q "Merge pull request\|Merge branch"; then
            echo "🔍 Merge commit detected"
            
            if [ "$IN_WINDOW" = "false" ]; then
              echo "🚫 DEPLOYMENT POLICY VIOLATION!"
              echo "Merge to ${{ github.ref_name }} occurred outside deployment window"
              echo "Allowed: Monday-Friday ${DEPLOY_START_HOUR}:00 - ${DEPLOY_END_HOUR}:00 $TIMEZONE"
              echo "Actual: $CURRENT_TIME"
              echo "Merged by: ${{ github.actor }}"
              echo "VIOLATION_DETECTED=true" >> $GITHUB_ENV
              exit 1
            fi
            echo "✅ Merge complies with deployment policy"
          fi
          
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          # Pre-merge validation
          if [ "$IN_WINDOW" = "false" ]; then
            echo "🚫 MERGE BLOCKED: Outside deployment window"
            echo "Deployment window: Monday-Friday ${DEPLOY_START_HOUR}:00 - ${DEPLOY_END_HOUR}:00 $TIMEZONE"
            echo "Current time: $CURRENT_TIME"
            echo "Please try again during business hours"
            exit 1
          fi
          echo "✅ Within deployment window - merge allowed"
        fi

    - name: Create violation issue
      if: env.VIOLATION_DETECTED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `🚨 Deployment Policy Violation - ${new Date().toLocaleDateString()}`,
            body: `
            ## Deployment Policy Violation Detected
            
            **Details:**
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            - **Merged by:** ${{ github.actor }}
            - **Time:** ${new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })}
            - **Event:** ${{ github.event_name }}
            
            **Policy:** Merges to main/master are only allowed Monday-Friday 9 AM - 4 PM EST
            
            **Action Required:** Please review this violation and consider process improvements.
            `,
            labels: ['policy-violation', 'deployment', 'urgent']
          });